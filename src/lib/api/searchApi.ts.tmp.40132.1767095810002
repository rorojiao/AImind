/**
 * 搜索API服务
 * 使用CORS代理访问搜索结果
 */

// 使用allorigins.win作为CORS代理
const CORS_PROXY = 'https://api.allorigins.win/raw?url=';

/**
 * 使用Google搜索结果（通过CORS代理）
 */
export async function searchGoogle(query: string): Promise<string[]> {
  try {
    const encodedQuery = encodeURIComponent(query);
    // 使用简洁的搜索结果页面
    const searchUrl = `https://www.google.com/search?q=${encodedQuery}&tbm=nws`;
    const proxiedUrl = `${CORS_PROXY}${encodeURIComponent(searchUrl)}`;

    const response = await fetch(proxiedUrl);
    if (!response.ok) {
      throw new Error('搜索请求失败');
    }

    const html = await response.text();

    // 简单的HTML解析来提取搜索结果
    const results: string[] = [];

    // 匹配Google搜索结果标题
    const titleRegex = /<h3[^>]*>(.+?)<\/h3>/g;
    let match;
    let count = 0;

    while ((match = titleRegex.exec(html)) !== null && count < 10) {
      // 移除HTML标签和多余空格
      let title = match[1]
        .replace(/<[^>]+>/g, '')
        .replace(/\s+/g, ' ')
        .trim();

      if (title && title.length > 5 && title.length < 100) {
        results.push(title);
        count++;
      }
    }

    return results;
  } catch (error) {
    console.error('Google搜索失败:', error);
    return [];
  }
}

/**
 * 使用Bing搜索结果（通过CORS代理）
 */
export async function searchBing(query: string): Promise<string[]> {
  try {
    const encodedQuery = encodeURIComponent(query);
    const searchUrl = `https://www.bing.com/news/search?q=${encodedQuery}`;
    const proxiedUrl = `${CORS_PROXY}${encodeURIComponent(searchUrl)}`;

    const response = await fetch(proxiedUrl);
    if (!response.ok) {
      throw new Error('搜索请求失败');
    }

    const html = await response.text();

    const results: string[] = [];

    // 匹配Bing新闻标题
    const titleRegex = /<a[^>]*title="([^"]+)"[^>]*>/g;
    let match;
    let count = 0;

    while ((match = titleRegex.exec(html)) !== null && count < 10) {
      const title = match[1].trim();
      if (title && title.length > 5 && title.length < 100) {
        results.push(title);
        count++;
      }
    }

    return results;
  } catch (error) {
    console.error('Bing搜索失败:', error);
    return [];
  }
}

/**
 * 组合搜索，尝试多个来源
 */
export async function searchMultiple(query: string): Promise<string[]> {
  // 并行尝试多个搜索源
  const [googleResults, bingResults] = await Promise.all([
    searchGoogle(query).catch(() => []),
    searchBing(query).catch(() => []),
  ]);

  // 合并去重
  const allResults = [...googleResults, ...bingResults];
  const uniqueResults = Array.from(new Set(allResults));

  return uniqueResults.slice(0, 10);
}
