// 网络搜索引擎 - 增强版：支持全行业专业领域

export interface SearchResult {
  title: string;
  url: string;
  snippet: string;
}

export interface SearchContext {
  query: string;
  results: SearchResult[];
  timestamp: number;
}

// ==================== 行业知识库 ====================

/**
 * 行业分类及关键词映射
 * 用于识别查询属于哪个行业领域
 */
const INDUSTRY_KEYWORDS = {
  // 互联网/科技
  tech: {
    name: '互联网/科技',
    keywords: [
      'AI', '人工智能', '机器学习', '深度学习', '算法', '数据', '大数据',
      '云计算', '云服务', 'SaaS', 'PaaS', 'IaaS',
      '区块链', '加密货币', 'Web3', 'NFT', '元宇宙',
      '软件开发', '编程', '代码', '架构', '框架', 'API',
      '移动应用', 'APP', '小程序', 'H5',
      '网络安全', '信息安全', '隐私保护',
      '物联网', 'IoT', '5G', '6G',
      '芯片', '半导体', '集成电路',
      'VR', 'AR', '虚拟现实', '增强现实',
      '自动化', '智能化', '数字化转型',
    ],
  },

  // 金融/投资
  finance: {
    name: '金融/投资',
    keywords: [
      '股票', '证券', '基金', '债券', '期货', '期权',
      '投资', '理财', '资产配置', '财富管理',
      '银行', '信贷', '贷款', '抵押', '融资',
      '保险', '理赔', '风控', '风险评估',
      '支付', '结算', '清算', '跨境支付',
      '金融科技', 'Fintech', '数字货币', '央行数字货币',
      '交易所', 'IPO', '上市', '私募', '创投', 'VC', 'PE',
      '财务', '会计', '审计', '税务',
      '利率', '汇率', '通胀', '通缩', 'GDP',
    ],
  },

  // 电商/零售
  ecommerce: {
    name: '电商/零售',
    keywords: [
      '电商', '电子商务', '网购', '平台',
      '淘宝', '天猫', '京东', '拼多多', '抖音电商', '快手电商',
      '亚马逊', 'eBay', 'Shopee', 'Lazada',
      '跨境电商', '出海', '海外仓',
      '直播带货', '主播', 'MCN',
      '供应链', '物流', '仓储', '配送',
      'SKU', '库存', '选品', '爆款',
      '营销', '推广', '流量', '转化率',
      '私域', '社群', '会员', 'CRM',
      '零售', '连锁', '便利店', '商超',
    ],
  },

  // 营销/运营
  marketing: {
    name: '营销/运营',
    keywords: [
      '营销', '市场', '品牌', '推广',
      '新媒体', '自媒体', '公众号', '小红书', '知乎',
      'SEO', 'SEM', 'ASO',
      '内容营销', '内容创作', '文案',
      '短视频', '抖音', '快手', '视频号',
      '社交电商', '社群团购', '裂变',
      '用户运营', '用户增长', '获客', '留存',
      '数据分析', '用户画像', '精细化运营',
      'KOL', 'KOC', '达人', '网红',
      '广告', '投放', 'ROI', 'CTR', 'CPC', 'CPM',
    ],
  },

  // 制造业
  manufacturing: {
    name: '制造业',
    keywords: [
      '制造', '生产', '加工', '装配',
      '工厂', '车间', '产线', '流水线',
      '工业4.0', '智能制造', '自动化',
      '设备', '机械', '仪器', '仪表',
      '质量管理', 'QA', 'QC', 'ISO',
      '供应链', '采购', '供应商',
      '成本控制', '效率提升', '精益生产',
      '研发', '设计', '原型', '测试',
      '材料', '原料', '半成品', '成品',
    ],
  },

  // 医疗/健康
  healthcare: {
    name: '医疗/健康',
    keywords: [
      '医疗', '医院', '诊所', '药店',
      '诊断', '治疗', '手术', '药物',
      '中医', '西医', '临床',
      '疾病', '症状', '病理', '病因',
      '护理', '康复', '保健',
      '医疗器械', '设备', '耗材',
      '健康', '养生', '健身', '运动',
      '营养', '饮食', '维生素', '补品',
      '心理健康', '心理咨询',
      '远程医疗', '互联网医疗',
    ],
  },

  // 教育/培训
  education: {
    name: '教育/培训',
    keywords: [
      '教育', '教学', '学习', '培训',
      '学校', '大学', '学院', '培训机构',
      '在线教育', '网课', '慕课', '知识付费',
      'K12', '学前教育', '职业教育', '成人教育',
      '课程', '教材', '课件', '教案',
      '老师', '教师', '讲师', '导师',
      '考试', '测评', '证书', '认证',
      '留学', '游学', '交换生',
      '教育科技', 'EdTech', '智慧教育',
    ],
  },

  // 房地产/建筑
  realestate: {
    name: '房地产/建筑',
    keywords: [
      '房地产', '楼市', '房价', '学区房',
      '买房', '卖房', '租房', '中介',
      '开发商', '楼盘', '小区', '物业',
      '建筑', '施工', '工程', '设计',
      '装修', '装饰', '家居', '建材',
      '城市规划', '土地利用',
      '商业地产', '写字楼', '商铺',
      '不动产', '投资回报', '租金',
    ],
  },

  // 法律/咨询
  legal: {
    name: '法律/咨询',
    keywords: [
      '法律', '法规', '条例', '政策',
      '合同', '协议', '条款',
      '诉讼', '仲裁', '调解',
      '律师', '律所', '法务',
      '知识产权', '专利', '商标', '版权',
      '公司法', '劳动法', '刑法', '民法',
      '咨询', '顾问', '专业服务',
      '合规', '风控', '尽调',
    ],
  },

  // 媒体/娱乐
  media: {
    name: '媒体/娱乐',
    keywords: [
      '媒体', '新闻', '出版', '报纸',
      '电视', '广播', '电台',
      '电影', '影视', '剧集', '综艺',
      '音乐', '歌曲', '专辑', '演唱会',
      '游戏', '电竞', '手游', '端游',
      '动漫', '漫画', '动画',
      '网红', '主播', 'UP主', '博主',
      '内容创作', 'IP', '版权',
      '娱乐', '明星', '艺人',
    ],
  },

  // 能源/环保
  energy: {
    name: '能源/环保',
    keywords: [
      '能源', '电力', '石油', '天然气',
      '新能源', '光伏', '太阳能', '风能',
      '核能', '水电', '火电',
      '环保', '环境', '污染', '排放',
      '碳中和', '碳达峰', '绿色能源',
      '储能', '电池', '充电桩',
      '节能', '减排', '可持续',
      'ESG', '社会责任',
    ],
  },

  // 交通/物流
  transport: {
    name: '交通/物流',
    keywords: [
      '交通', '运输', '出行',
      '汽车', '车辆', '新能源车', '电动车',
      '航空', '飞机', '机场', '航线',
      '铁路', '高铁', '地铁', '轻轨',
      '海运', '港口', '集装箱',
      '物流', '快递', '配送',
      '仓储', '库存', '供应链',
      '导航', '地图', 'GPS',
      '智慧交通', '自动驾驶',
    ],
  },

  // 农业/食品
  agriculture: {
    name: '农业/食品',
    keywords: [
      '农业', '农村', '农民',
      '种植', '养殖', '渔业', '畜牧',
      '农产品', '粮食', '蔬菜', '水果',
      '农机', '农药', '化肥',
      '食品', '饮料', '餐饮',
      '食品安全', '质量检测',
      '预制菜', '冷链',
      '农业科技', '智慧农业',
    ],
  },

  // 人力资源
  hr: {
    name: '人力资源',
    keywords: [
      '人力资源', 'HR', '人事',
      '招聘', '求职', '简历', '面试',
      '培训', '发展', '晋升',
      '薪酬', '福利', '绩效',
      '组织架构', '团队管理',
      '企业文化', '员工关系',
      '离职', '裁员', '优化',
      '灵活用工', '外包',
    ],
  },

  // 创业/商业
  business: {
    name: '创业/商业',
    keywords: [
      '创业', '企业家', '创始人',
      '商业模式', '盈利模式',
      '融资', '投资', '路演',
      '商业计划', 'BP',
      '合伙人', '股权', '期权',
      '创新', '转型', '升级',
      '市场', '竞争', '差异化',
      '变现', '赚钱', '利润',
      '矩阵', '起号', '出海',
    ],
  },
};

/**
 * 行业知识库 - 专业内容
 * 提供各行业的专业知识和实践方法
 */
const INDUSTRY_KNOWLEDGE: Record<string, string[]> = {
  // 互联网/科技
  tech: [
    'AI大模型应用：ChatGPT、Claude、文心一言等大模型赋能各行业',
    '机器学习算法：监督学习、无监督学习、强化学习的实际应用场景',
    '云计算架构：公有云、私有云、混合云的选择和部署策略',
    '微服务架构：将单体应用拆分为多个微服务的最佳实践',
    'DevOps实践：CI/CD流水线、容器化、自动化运维',
    '数据中台建设：数据治理、数据质量、数据安全',
    '网络安全防护：零信任架构、渗透测试、安全加固',
    '敏捷开发：Scrum、Kanban等敏捷方法论的实施',
    'API设计：RESTful、GraphQL、gRPC的选择和应用',
    '用户体验设计：用户研究、交互设计、视觉设计',
  ],

  // 金融/投资
  finance: [
    '价值投资理念：巴菲特式长期投资策略',
    '技术分析：K线图、均线、MACD等技术指标应用',
    '基本面分析：财务报表分析、估值模型',
    '风险管理：止损策略、仓位管理、分散投资',
    '量化交易：算法交易、高频交易策略',
    '资产配置：股票、债券、商品、房地产的配置比例',
    '被动投资：指数基金、ETF投资策略',
    '金融科技应用：智能投顾、区块链金融',
    '财务规划：个人理财、退休规划、税务优化',
    '市场情绪分析：恐惧贪婪指数、资金流向',
  ],

  // 电商/零售
  ecommerce: [
    '选品策略：数据分析选品、竞品分析、趋势预测',
    '店铺运营：标题优化、主图设计、详情页优化',
    '流量获取：搜索流量、推荐流量、站外引流',
    '转化优化：客服话术、促销活动、优惠券设计',
    '供应链管理：供应商选择、库存周转、成本控制',
    '直播带货：直播间搭建、主播话术、产品展示',
    '私域运营：微信群运营、会员体系、复购提升',
    '跨境电商：平台选择、物流方案、本地化运营',
    '数据分析：GMV、UV、转化率、客单价分析',
    '品牌建设：品牌定位、视觉识别、内容营销',
  ],

  // 营销/运营
  marketing: [
    '内容营销：爆款内容创作、内容分发矩阵',
    '短视频运营：脚本策划、拍摄技巧、剪辑后期',
    '社交媒体运营：双微一抖、小红书、知乎运营',
    'SEO优化：关键词布局、外链建设、网站结构优化',
    '付费广告：信息流广告、搜索广告、品牌广告投放',
    '用户增长：AARRR模型、增长黑客实验',
    '私域流量：社群运营、会员体系、裂变营销',
    '数据分析：用户画像、漏斗分析、归因分析',
    '品牌营销：品牌故事、品牌联名、公关传播',
    'KOL营销：达人筛选、内容共创、效果追踪',
  ],

  // 制造业
  manufacturing: [
    '精益生产：消除浪费、持续改善、价值流映射',
    '六西格玛：DMAIC方法、统计过程控制',
    '智能制造：工业互联网、数字孪生、预测性维护',
    '质量管理：全面质量管理TQM、质量管理体系ISO',
    '供应链优化：JIT准时制生产、VMI供应商管理库存',
    '设备管理：TPM全员生产维护、OEE设备综合效率',
    '成本控制：目标成本法、作业成本法ABC',
    '研发创新：IPD集成产品开发、快速原型验证',
    '柔性制造：小批量多品种、快速换模',
    '安全生产：风险辨识、应急预案、安全培训',
  ],

  // 医疗/健康
  healthcare: [
    '精准医疗：基因检测、个性化治疗方案',
    '远程医疗：在线问诊、远程监护、处方流转',
    '临床决策：循证医学、临床路径、多学科会诊',
    '慢病管理：高血压、糖尿病等慢性病长期管理',
    '健康管理：体检筛查、健康评估、干预指导',
    '医疗AI：医学影像AI诊断、辅助诊疗系统',
    '药物研发：新药临床试验、真实世界研究',
    '护理服务：优质护理、人文关怀、延续性护理',
    '康复医学：功能评估、康复训练、辅具应用',
    '医院管理：DRG付费、绩效考核、运营优化',
  ],

  // 教育/培训
  education: [
    '在线教育：直播教学、录播课程、互动答疑',
    '混合式学习：线上线下结合的教学模式',
    '个性化学习：AI推荐、自适应学习路径',
    '教学设计：学习目标设计、教学活动设计',
    '课程开发：微课制作、慕课建设、教材编写',
    '学习测评：形成性评价、总结性评价、能力画像',
    '教师发展：专业培训、教学研究、名师培养',
    '教育信息化：智慧教室、学习管理系统LMS',
    '职业教育：产教融合、校企合作、1+X证书',
    '终身学习：学习型组织、知识管理、技能提升',
  ],

  // 房地产/建筑
  realestate: [
    '投资策略：地段选择、价值洼地、周期判断',
    '购房指南：首付预算、贷款方案、合同条款',
    '租房技巧：房源筛选、租金谈判、合同审查',
    '装修设计：风格选择、空间规划、材料选购',
    '物业管理：服务标准、费用管理、维修保养',
    '商业地产：写字楼选址、商铺投资、园区运营',
    '城市规划：区域发展、交通规划、配套设施',
    '建筑技术：绿色建筑、装配式建筑、BIM技术',
    '市场分析：供需关系、价格走势、政策影响',
    '资产运营：收益测算、资产增值、退出策略',
  ],

  // 法律/咨询
  legal: [
    '合同管理：合同起草、条款审查、风险防范',
    '知识产权：专利申请、商标注册、版权保护',
    '合规管理：反垄断、反腐败、数据合规',
    '争议解决：谈判策略、调解技巧、诉讼策略',
    '公司治理：股权结构、董事会运作、关联交易',
    '劳动用工：劳动合同、社保公积金、解除劳动关系',
    '尽职调查：财务尽调、法务尽调、业务尽调',
    '风险管理：风险识别、风险评估、风险应对',
    '税务筹划：合理避税、税收优惠、转让定价',
    '咨询服务：问题诊断、方案设计、落地实施',
  ],

  // 媒体/娱乐
  media: [
    '内容创作：IP孵化、剧本创作、内容策划',
    '短视频制作：拍摄技巧、剪辑软件、特效包装',
    '直播运营：直播策划、互动技巧、转化策略',
    '自媒体运营：账号定位、内容规划、粉丝运营',
    'MCN机构：达人孵化、商业变现、资源整合',
    '影视制作：制片管理、拍摄流程、后期制作',
    '音乐产业：版权运营、数字音乐、现场演出',
    '游戏开发：游戏设计、美术资源、程序开发',
    '电竞产业：赛事运营、选手培养、商业化',
    '品牌营销：品牌植入、效果广告、社交传播',
  ],

  // 能源/环保
  energy: [
    '新能源发展：光伏、风电、储能装机预测',
    '碳中和路径：能源结构转型、节能减排措施',
    '绿色金融：碳交易、绿色债券、ESG投资',
    '智慧能源：能源互联网、虚拟电厂、需求响应',
    '新能源汽车：电池技术、充电设施、产业链',
    '环保技术：废水处理、废气治理、固废利用',
    '循环经济：资源回收、再制造、共享经济',
    '能源效率：节能技术、能耗监测、能效管理',
    '政策解读：双碳目标、新能源补贴、碳关税',
    '投资机会：储能、氢能、CCUS等前沿技术',
  ],

  // 交通/物流
  transport: [
    '智能交通：信号优化、路况预测、智慧停车',
    '自动驾驶：L2-L5级别技术路线、商业化进程',
    '新能源汽车：电池技术、充电网络、车型选择',
    '物流网络：仓网布局、路由优化、最后一公里',
    '供应链管理：JIT配送、VMI库存、可视化追踪',
    '跨境电商物流：海外仓、专线物流、清关代理',
    '快递配送：时效承诺、末端网点、智能柜',
    '货运平台：车货匹配、运价优化、信用评价',
    '出行服务：网约车、共享单车、定制公交',
    '交通规划：路网设计、公交优先、慢行系统',
  ],

  // 农业/食品
  agriculture: [
    '智慧农业：物联网监测、精准灌溉、无人机植保',
    '特色种植：有机农业、设施农业、品种改良',
    '现代养殖：规模化养殖、疫病防控、粪污处理',
    '农产品电商：产地直供、直播带货、品牌打造',
    '食品加工：深加工、预制菜、冷链物流',
    '食品安全：溯源体系、检测认证、标准制定',
    '农业金融：保险服务、信贷支持、期货套保',
    '乡村旅游：农旅融合、民宿经济、体验农业',
    '农业科技：基因育种、生物农药、智能装备',
    '乡村振兴：产业振兴、人才振兴、文化振兴',
  ],

  // 人力资源
  hr: [
    '招聘管理：人才画像、招聘渠道、面试技巧',
    '培训发展：新员工培训、技能提升、领导力发展',
    '绩效管理：KPI设置、OKR实施、反馈面谈',
    '薪酬激励：宽带薪酬、股权激励、福利设计',
    '组织发展：组织诊断、变革管理、文化建设',
    '员工关系：沟通机制、员工关怀、冲突处理',
    '人才盘点：九宫格、继任计划、关键人才保留',
    '灵活用工：兼职、外包、自由职业者管理',
    'HR数字化：HRIS系统、数据分析、AI面试',
    '雇主品牌：品牌定位、员工推荐、社会责任',
  ],

  // 创业/商业
  business: [
    '创业方向：市场机会分析、赛道选择、时机判断',
    '商业计划：价值主张、商业模式、财务预测',
    '融资策略：BP撰写、路演技巧、估值谈判',
    '团队组建：合伙人选择、股权分配、激励机制',
    '产品开发：MVP验证、用户反馈、快速迭代',
    '市场推广：获客渠道、增长黑客、品牌建设',
    '财务管理：现金流管理、成本控制、盈利模式',
    '风险控制：法律风险、市场风险、财务风险',
    '出海策略：目标市场、本地化、合规经营',
    '退出机制：并购退出、IPO上市、股权转让',
  ],
};

// ==================== 搜索功能 ====================

/**
 * 智能判断是否需要搜索
 * 基于行业关键词和专业术语识别
 */
export function shouldSearchOnline(nodeContent: string, depth: number): boolean {
  // 如果深度太深，通常不需要搜索
  if (depth > 2) return false;

  const content = nodeContent.toLowerCase();

  // 检查是否包含任何行业关键词
  for (const industry of Object.values(INDUSTRY_KEYWORDS)) {
    for (const keyword of industry.keywords) {
      if (content.includes(keyword.toLowerCase())) {
        return true;
      }
    }
  }

  // 时效性关键词 - 需要最新信息
  const timeSensitiveKeywords = [
    '最新', '2024', '2025', '2026', '趋势', '动态', '新闻',
    '价格', '费用', '成本', '行情', '汇率',
    '发布', '推出', '上线', '更新', '升级',
    '政策', '法规', '标准', '规范',
  ];

  if (timeSensitiveKeywords.some(k => content.includes(k))) {
    return true;
  }

  // 检查是否是问句形式
  if (nodeContent.includes('？') || nodeContent.includes('?') || nodeContent.includes('如何') || nodeContent.includes('怎么')) {
    return true;
  }

  // 检查是否是具体的专有名词（大写字母较多）
  const uppercaseRatio = (nodeContent.match(/[A-Z]/g) || []).length / nodeContent.length;
  if (uppercaseRatio > 0.3) {
    return true;
  }

  return false;
}

/**
 * 识别查询所属的行业
 */
export function identifyIndustry(query: string): string | null {
  const lowerQuery = query.toLowerCase();

  for (const [key, industry] of Object.entries(INDUSTRY_KEYWORDS)) {
    for (const keyword of industry.keywords) {
      if (lowerQuery.includes(keyword.toLowerCase())) {
        return key;
      }
    }
  }

  return null;
}

/**
 * 生成搜索查询
 * 基于节点内容和上下文生成优化的搜索词
 */
export function generateSearchQuery(
  nodeContent: string,
  parentContent: string | null,
  _rootTopic: string
): string {
  // 如果是根节点，直接搜索主题
  if (!parentContent) {
    return `${nodeContent} 指南 方法`;
  }

  // 组合父节点和当前节点生成查询
  const query = `${parentContent} ${nodeContent}`;

  // 根据内容类型添加后缀
  const suffixes = ['方法', '指南', '技巧', '实践', '步骤', '教程', '案例分析', '最佳实践'];
  const relevantSuffix = suffixes[Math.floor(Math.random() * suffixes.length)];

  return `${query} ${relevantSuffix}`;
}

/**
 * 检测语言类型
 */
export function detectLanguage(content: string): 'zh' | 'en' | 'mixed' {
  const chineseChars = (content.match(/[\u4e00-\u9fa5]/g) || []).length;
  const totalChars = content.length;

  if (chineseChars / totalChars > 0.3) {
    return 'zh';
  } else if (chineseChars === 0) {
    return 'en';
  } else {
    return 'mixed';
  }
}

/**
 * 执行网络搜索
 * 使用全局搜索函数（如果可用）
 */
export async function searchMultiple(query: string): Promise<string[]> {
  // 检查是否有全局搜索函数（由MCP或其他方式注入）
  const globalSearch = (globalThis as any).performWebSearch;

  if (!globalSearch || typeof globalSearch !== 'function') {
    console.warn('Web search function not available, using fallback');
    return [];
  }

  try {
    const results = await globalSearch(query);
    return results || [];
  } catch (error) {
    console.error('Search failed:', error);
    return [];
  }
}

/**
 * 获取智能搜索结果（Fallback机制）
 * 基于行业知识库提供专业内容
 */
export function getFallbackResults(query: string): string[] {
  const industry = identifyIndustry(query);

  if (industry && INDUSTRY_KNOWLEDGE[industry]) {
    return INDUSTRY_KNOWLEDGE[industry];
  }

  // 如果没有识别到具体行业，返回通用商业知识
  return [
    '战略规划：明确目标、制定路径、资源配置',
    '市场分析：行业趋势、竞争格局、用户需求',
    '产品策略：产品定位、功能规划、路线图',
    '运营体系：流程设计、团队协作、绩效管理',
    '数据分析：指标体系、数据采集、洞察决策',
    '风险控制：风险识别、应对措施、预案准备',
    '持续改进：复盘总结、优化迭代、创新突破',
    '团队建设：人才招聘、能力培养、文化建设',
    '财务管理：预算管理、成本控制、盈利分析',
    '客户服务：需求响应、问题解决、关系维护',
  ];
}
