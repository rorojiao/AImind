// 网络搜索引擎 - 增强版：支持全行业专业领域

export interface SearchResult {
  title: string;
  url: string;
  snippet: string;
}

export interface SearchContext {
  query: string;
  results: SearchResult[];
  timestamp: number;
}

// ==================== 行业知识库 ====================

/**
 * 行业分类及关键词映射
 * 用于识别查询属于哪个行业领域
 */
const INDUSTRY_KEYWORDS = {
  // 互联网/科技
  tech: {
    name: '互联网/科技',
    keywords: [
      'AI', '人工智能', '机器学习', '深度学习', '算法', '数据', '大数据',
      '云计算', '云服务', 'SaaS', 'PaaS', 'IaaS',
      '区块链', '加密货币', 'Web3', 'NFT', '元宇宙',
      '软件开发', '编程', '代码', '架构', '框架', 'API',
      '移动应用', 'APP', '小程序', 'H5',
      '网络安全', '信息安全', '隐私保护',
      '物联网', 'IoT', '5G', '6G',
      '芯片', '半导体', '集成电路',
      'VR', 'AR', '虚拟现实', '增强现实',
      '自动化', '智能化', '数字化转型',
    ],
  },

  // 金融/投资
  finance: {
    name: '金融/投资',
    keywords: [
      '股票', '证券', '基金', '债券', '期货', '期权',
      '投资', '理财', '资产配置', '财富管理',
      '银行', '信贷', '贷款', '抵押', '融资',
      '保险', '理赔', '风控', '风险评估',
      '支付', '结算', '清算', '跨境支付',
      '金融科技', 'Fintech', '数字货币', '央行数字货币',
      '交易所', 'IPO', '上市', '私募', '创投', 'VC', 'PE',
      '财务', '会计', '审计', '税务',
      '利率', '汇率', '通胀', '通缩', 'GDP',
    ],
  },

  // 电商/零售
  ecommerce: {
    name: '电商/零售',
    keywords: [
      '电商', '电子商务', '网购', '平台',
      '淘宝', '天猫', '京东', '拼多多', '抖音电商', '快手电商',
      '亚马逊', 'eBay', 'Shopee', 'Lazada',
      '跨境电商', '出海', '海外仓',
      '直播带货', '主播', 'MCN',
      '供应链', '物流', '仓储', '配送',
      'SKU', '库存', '选品', '爆款',
      '营销', '推广', '流量', '转化率',
      '私域', '社群', '会员', 'CRM',
      '零售', '连锁', '便利店', '商超',
    ],
  },

  // 营销/运营
  marketing: {
    name: '营销/运营',
    keywords: [
      '营销', '市场', '品牌', '推广',
      '新媒体', '自媒体', '公众号', '小红书', '知乎',
      'SEO', 'SEM', 'ASO',
      '内容营销', '内容创作', '文案',
      '短视频', '抖音', '快手', '视频号',
      '社交电商', '社群团购', '裂变',
      '用户运营', '用户增长', '获客', '留存',
      '数据分析', '用户画像', '精细化运营',
      'KOL', 'KOC', '达人', '网红',
      '广告', '投放', 'ROI', 'CTR', 'CPC', 'CPM',
    ],
  },

  // 制造业
  manufacturing: {
    name: '制造业',
    keywords: [
      '制造', '生产', '加工', '装配',
      '工厂', '车间', '产线', '流水线',
      '工业4.0', '智能制造', '自动化',
      '设备', '机械', '仪器', '仪表',
      '质量管理', 'QA', 'QC', 'ISO',
      '供应链', '采购', '供应商',
      '成本控制', '效率提升', '精益生产',
      '研发', '设计', '原型', '测试',
      '材料', '原料', '半成品', '成品',
    ],
  },

  // 医疗/健康
  healthcare: {
    name: '医疗/健康',
    keywords: [
      '医疗', '医院', '诊所', '药店',
      '诊断', '治疗', '手术', '药物',
      '中医', '西医', '临床',
      '疾病', '症状', '病理', '病因',
      '护理', '康复', '保健',
      '医疗器械', '设备', '耗材',
      '健康', '养生', '健身', '运动',
      '营养', '饮食', '维生素', '补品',
      '心理健康', '心理咨询',
      '远程医疗', '互联网医疗',
    ],
  },

  // 教育/培训
  education: {
    name: '教育/培训',
    keywords: [
      '教育', '教学', '学习', '培训',
      '学校', '大学', '学院', '培训机构',
      '在线教育', '网课', '慕课', '知识付费',
      'K12', '学前教育', '职业教育', '成人教育',
      '课程', '教材', '课件', '教案',
      '老师', '教师', '讲师', '导师',
      '考试', '测评', '证书', '认证',
      '留学', '游学', '交换生',
      '教育科技', 'EdTech', '智慧教育',
    ],
  },

  // 房地产/建筑
  realestate: {
    name: '房地产/建筑',
    keywords: [
      '房地产', '楼市', '房价', '学区房',
      '买房', '卖房', '租房', '中介',
      '开发商', '楼盘', '小区', '物业',
      '建筑', '施工', '工程', '设计',
      '装修', '装饰', '家居', '建材',
      '城市规划', '土地利用',
      '商业地产', '写字楼', '商铺',
      '不动产', '投资回报', '租金',
    ],
  },

  // 法律/咨询
  legal: {
    name: '法律/咨询',
    keywords: [
      '法律', '法规', '条例', '政策',
      '合同', '协议', '条款',
      '诉讼', '仲裁', '调解',
      '律师', '律所', '法务',
      '知识产权', '专利', '商标', '版权',
      '公司法', '劳动法', '刑法', '民法',
      '咨询', '顾问', '专业服务',
      '合规', '风控', '尽调',
    ],
  },

  // 媒体/娱乐
  media: {
    name: '媒体/娱乐',
    keywords: [
      '媒体', '新闻', '出版', '报纸',
      '电视', '广播', '电台',
      '电影', '影视', '剧集', '综艺',
      '音乐', '歌曲', '专辑', '演唱会',
      '游戏', '电竞', '手游', '端游',
      '动漫', '漫画', '动画',
      '网红', '主播', 'UP主', '博主',
      '内容创作', 'IP', '版权',
      '娱乐', '明星', '艺人',
    ],
  },

  // 能源/环保
  energy: {
    name: '能源/环保',
    keywords: [
      '能源', '电力', '石油', '天然气',
      '新能源', '光伏', '太阳能', '风能',
      '核能', '水电', '火电',
      '环保', '环境', '污染', '排放',
      '碳中和', '碳达峰', '绿色能源',
      '储能', '电池', '充电桩',
      '节能', '减排', '可持续',
      'ESG', '社会责任',
    ],
  },

  // 交通/物流
  transport: {
    name: '交通/物流',
    keywords: [
      '交通', '运输', '出行',
      '汽车', '车辆', '新能源车', '电动车',
      '航空', '飞机', '机场', '航线',
      '铁路', '高铁', '地铁', '轻轨',
      '海运', '港口', '集装箱',
      '物流', '快递', '配送',
      '仓储', '库存', '供应链',
      '导航', '地图', 'GPS',
      '智慧交通', '自动驾驶',
    ],
  },

  // 农业/食品
  agriculture: {
    name: '农业/食品',
    keywords: [
      '农业', '农村', '农民',
      '种植', '养殖', '渔业', '畜牧',
      '农产品', '粮食', '蔬菜', '水果',
      '农机', '农药', '化肥',
      '食品', '饮料', '餐饮',
      '食品安全', '质量检测',
      '预制菜', '冷链',
      '农业科技', '智慧农业',
    ],
  },

  // 人力资源
  hr: {
    name: '人力资源',
    keywords: [
      '人力资源', 'HR', '人事',
      '招聘', '求职', '简历', '面试',
      '培训', '发展', '晋升',
      '薪酬', '福利', '绩效',
      '组织架构', '团队管理',
      '企业文化', '员工关系',
      '离职', '裁员', '优化',
      '灵活用工', '外包',
    ],
  },

  // 创业/商业
  business: {
    name: '创业/商业',
    keywords: [
      '创业', '企业家', '创始人',
      '商业模式', '盈利模式',
      '融资', '投资', '路演',
      '商业计划', 'BP',
      '合伙人', '股权', '期权',
      '创新', '转型', '升级',
      '市场', '竞争', '差异化',
      '变现', '赚钱', '利润',
      '矩阵', '起号', '出海',
    ],
  },
};

/**
 * 行业知识库 - 专业内容
 * 提供各行业的专业知识和实践方法
 * 每个行业20-30条知识，可根据需要灵活组合使用
 */
const INDUSTRY_KNOWLEDGE: Record<string, string[]> = {
  // 互联网/科技
  tech: [
    'AI大模型应用：ChatGPT、Claude、文心一言等大模型赋能各行业',
    '机器学习算法：监督学习、无监督学习、强化学习的实际应用场景',
    '深度学习框架：TensorFlow、PyTorch、Keras等框架选型与实践',
    '云计算架构：公有云、私有云、混合云的选择和部署策略',
    '微服务架构：将单体应用拆分为多个微服务的最佳实践',
    '容器化技术：Docker、Kubernetes的容器编排与管理',
    'DevOps实践：CI/CD流水线、容器化、自动化运维',
    '数据中台建设：数据治理、数据质量、数据安全',
    '网络安全防护：零信任架构、渗透测试、安全加固',
    '敏捷开发：Scrum、Kanban等敏捷方法论的实施',
    'API设计：RESTful、GraphQL、gRPC的选择和应用',
    '用户体验设计：用户研究、交互设计、视觉设计',
    '前端框架：React、Vue、Angular的选型和生态',
    '后端架构：Spring Boot、Django、Express等后端技术',
    '数据库设计：MySQL、PostgreSQL、MongoDB等数据库选型',
    '消息队列：Kafka、RabbitMQ、RocketMQ等消息中间件',
    '搜索引擎：Elasticsearch、Solr等全文检索方案',
    '大数据处理：Hadoop、Spark、Flink等大数据技术栈',
    '区块链应用：智能合约、DeFi、NFT等区块链应用场景',
    '边缘计算：CDN、边缘节点、就近计算等边缘技术',
    '物联网平台：设备接入、数据采集、远程控制',
    '5G/6G技术：新一代通信技术的应用和影响',
    '虚拟化技术：VMware、KVM等虚拟化方案',
    '服务器less：无服务器架构、函数计算、按需付费',
    '代码质量：单元测试、代码审查、持续集成',
    '性能优化：缓存策略、负载均衡、CDN加速',
    '技术债务管理：代码重构、架构演进、技术选型',
  ],

  // 金融/投资
  finance: [
    '价值投资理念：巴菲特式长期投资策略',
    '技术分析：K线图、均线、MACD等技术指标应用',
    '基本面分析：财务报表分析、估值模型',
    '风险管理：止损策略、仓位管理、分散投资',
    '量化交易：算法交易、高频交易策略',
    '资产配置：股票、债券、商品、房地产的配置比例',
    '被动投资：指数基金、ETF投资策略',
    '金融科技应用：智能投顾、区块链金融',
    '财务规划：个人理财、退休规划、税务优化',
    '市场情绪分析：恐惧贪婪指数、资金流向',
    '宏观经济分析：GDP、CPI、PMI等经济指标',
    '行业研究：产业链分析、竞争格局、估值方法',
    '公司分析：商业模式、护城河、成长性分析',
    '债券投资：国债、企业债、可转债的投资策略',
    '基金投资：主动基金、指数基金的选择方法',
    '期货期权：套期保值、套利交易策略',
    '外汇交易：汇率分析、货币对选择、风险控制',
    '加密货币：比特币、以太坊等数字货币投资',
    'REITs投资：房地产信托基金的投资价值',
    '众筹投资：股权众筹、产品众筹的风险与收益',
  ],

  // 电商/零售
  ecommerce: [
    '选品策略：数据分析选品、竞品分析、趋势预测',
    '店铺运营：标题优化、主图设计、详情页优化',
    '流量获取：搜索流量、推荐流量、站外引流',
    '转化优化：客服话术、促销活动、优惠券设计',
    '供应链管理：供应商选择、库存周转、成本控制',
    '直播带货：直播间搭建、主播话术、产品展示',
    '私域运营：微信群运营、会员体系、复购提升',
    '跨境电商：平台选择、物流方案、本地化运营',
    '数据分析：GMV、UV、转化率、客单价分析',
    '品牌建设：品牌定位、视觉识别、内容营销',
    '产品定价：成本定价、竞争定价、心理定价',
    '客户服务：售前咨询、售后服务、纠纷处理',
    '评价管理：好评获取、差评处理、评分维护',
    '活动策划：双11、618等大促活动策划',
    '内容种草：小红书、抖音等内容平台种草',
    '达人合作：KOL/KOC合作、直播带货、佣金结算',
    '用户运营：用户分层、精准营销、生命周期管理',
    '仓储物流：仓储布局、物流优化、配送时效',
    '支付方式：支付宝、微信支付等支付方式对接',
    '海外市场：亚马逊、Shopee等海外平台运营',
    '本地生活：美团、饿了么等本地生活平台',
  ],

  // 营销/运营
  marketing: [
    '内容营销：爆款内容创作、内容分发矩阵',
    '短视频运营：脚本策划、拍摄技巧、剪辑后期',
    '社交媒体运营：双微一抖、小红书、知乎运营',
    'SEO优化：关键词布局、外链建设、网站结构优化',
    '付费广告：信息流广告、搜索广告、品牌广告投放',
    '用户增长：AARRR模型、增长黑客实验',
    '私域流量：社群运营、会员体系、裂变营销',
    '数据分析：用户画像、漏斗分析、归因分析',
    '品牌营销：品牌故事、品牌联名、公关传播',
    'KOL营销：达人筛选、内容共创、效果追踪',
    '事件营销：热点追踪、话题策划、病毒传播',
    '场景营销：消费场景、使用场景、情感场景',
    '体验营销：用户体验、服务体验、品牌体验',
    '精准营销：人群定向、精准投放、ROI优化',
    '口碑营销：用户评价、口碑传播、社群扩散',
    '跨界营销：品牌合作、IP联名、场景联动',
    '社群营销：社群搭建、社群运营、社群变现',
    '直播营销：直播策划、直播互动、直播转化',
    '节日营销：节日主题、促销活动、氛围营造',
    '地域营销：本地化、区域化、全国化策略',
  ],

  // 制造业
  manufacturing: [
    '精益生产：消除浪费、持续改善、价值流映射',
    '六西格玛：DMAIC方法、统计过程控制',
    '智能制造：工业互联网、数字孪生、预测性维护',
    '质量管理：全面质量管理TQM、质量管理体系ISO',
    '供应链优化：JIT准时制生产、VMI供应商管理库存',
    '设备管理：TPM全员生产维护、OEE设备综合效率',
    '成本控制：目标成本法、作业成本法ABC',
    '研发创新：IPD集成产品开发、快速原型验证',
    '柔性制造：小批量多品种、快速换模',
    '安全生产：风险辨识、应急预案、安全培训',
    '生产计划：产能规划、排产优化、交期管理',
    '物料管理：MRP物料需求计划、BOM物料清单',
    '工艺优化：工艺流程、工艺参数、工艺验证',
    '检测技术：在线检测、无损检测、智能检测',
    '能源管理：能耗监测、节能技术、能源优化',
    '环保合规：排放控制、废物处理、环保认证',
    '工厂布局：车间布局、物流路径、人机工程',
    '人员培训：技能培训、多能工培养、激励机制',
    '供应商管理：供应商评估、供应商开发、供应商协同',
    '库存控制：安全库存、最大库存、库存周转',
  ],

  // 医疗/健康
  healthcare: [
    '精准医疗：基因检测、个性化治疗方案',
    '远程医疗：在线问诊、远程监护、处方流转',
    '临床决策：循证医学、临床路径、多学科会诊',
    '慢病管理：高血压、糖尿病等慢性病长期管理',
    '健康管理：体检筛查、健康评估、干预指导',
    '医疗AI：医学影像AI诊断、辅助诊疗系统',
    '药物研发：新药临床试验、真实世界研究',
    '护理服务：优质护理、人文关怀、延续性护理',
    '康复医学：功能评估、康复训练、辅具应用',
    '医院管理：DRG付费、绩效考核、运营优化',
    '分级诊疗：基层首诊、双向转诊、急慢分治',
    '医疗质量：医疗安全、质量控制、持续改进',
    '医患关系：沟通技巧、纠纷预防、满意度提升',
    '智慧医院：信息化建设、智能化服务、便捷就医',
    '预防保健：疫苗接种、健康宣教、疾病预防',
    '中医服务：中医诊疗、中药服务、养生保健',
    '医学影像：影像诊断、影像存储、远程影像',
    '检验检测：检验项目、质量控制、结果解读',
    '医院感染：院感防控、消毒隔离、抗菌药物管理',
  ],

  // 教育/培训
  education: [
    '在线教育：直播教学、录播课程、互动答疑',
    '混合式学习：线上线下结合的教学模式',
    '个性化学习：AI推荐、自适应学习路径',
    '教学设计：学习目标设计、教学活动设计',
    '课程开发：微课制作、慕课建设、教材编写',
    '学习测评：形成性评价、总结性评价、能力画像',
    '教师发展：专业培训、教学研究、名师培养',
    '教育信息化：智慧教室、学习管理系统LMS',
    '职业教育：产教融合、校企合作、1+X证书',
    '终身学习：学习型组织、知识管理、技能提升',
    'K12教育：素质教育、STEAM教育、创客教育',
    '高等教育：专业建设、课程改革、创新创业',
    '幼儿教育：游戏化学习、习惯培养、家园共育',
    '特殊教育：融合教育、个别化教育、辅助技术',
    '国际教育：国际课程、留学申请、跨文化适应',
    '教育公平：资源均衡、机会公平、质量公平',
    '学习科学：认知规律、学习策略、脑科学应用',
    '教育技术：VR/AR教学、AI助教、智能批改',
    '家校共育：家长参与、沟通机制、协同育人',
  ],

  // 房地产/建筑
  realestate: [
    '投资策略：地段选择、价值洼地、周期判断',
    '购房指南：首付预算、贷款方案、合同条款',
    '租房技巧：房源筛选、租金谈判、合同审查',
    '装修设计：风格选择、空间规划、材料选购',
    '物业管理：服务标准、费用管理、维修保养',
    '商业地产：写字楼选址、商铺投资、园区运营',
    '城市规划：区域发展、交通规划、配套设施',
    '建筑技术：绿色建筑、装配式建筑、BIM技术',
    '市场分析：供需关系、价格走势、政策影响',
    '资产运营：收益测算、资产增值、退出策略',
    '房产税法：税收政策、法律风险、合规要求',
    '二手房交易：交易流程、税费计算、风险控制',
    '新房选购：楼盘比较、样板间、交房标准',
    '豪宅市场：豪宅定义、豪宅投资、豪宅定制',
    '长租公寓：运营模式、盈利模式、风险控制',
    '共有产权：资格条件、产权比例、退出机制',
    '公积金：公积金贷款、公积金提取、政策变化',
    '房贷管理：利率选择、还款方式、提前还款',
    '产权登记：不动产登记、产权变更、抵押登记',
  ],

  // 法律/咨询
  legal: [
    '合同管理：合同起草、条款审查、风险防范',
    '知识产权：专利申请、商标注册、版权保护',
    '合规管理：反垄断、反腐败、数据合规',
    '争议解决：谈判策略、调解技巧、诉讼策略',
    '公司治理：股权结构、董事会运作、关联交易',
    '劳动用工：劳动合同、社保公积金、解除劳动关系',
    '尽职调查：财务尽调、法务尽调、业务尽调',
    '风险管理：风险识别、风险评估、风险应对',
    '税务筹划：合理避税、税收优惠、转让定价',
    '咨询服务：问题诊断、方案设计、落地实施',
    '婚姻家事：婚前协议、离婚协议、财产分割',
    '刑事辩护：取保候审、无罪辩护、罪轻辩护',
    '行政诉讼：行政复议、行政诉讼、国家赔偿',
    '建设工程：工程合同、工程款、工程质量',
    '房地产法：购房合同、租赁合同、产权纠纷',
    '破产清算：破产申请、清算程序、债务重组',
    '海商海事：海上运输、海上保险、海事纠纷',
    '涉外法律：国际仲裁、跨境投资、国际贸易',
    '法律文书：起诉状、答辩状、法律意见书',
  ],

  // 媒体/娱乐（含游戏出海）
  media: [
    // 游戏出海相关
    '手游出海：海外市场选择、本地化运营、文化适配',
    '游戏出海：发行策略、渠道选择、推广方案',
    '手游发行：海外上架流程、ASO优化、评分管理',
    '海外游戏市场：东南亚、日韩、欧美、中东市场特点',
    '游戏本地化：语言翻译、文化适配、UI调整',
    '海外游戏支付：支付方式对接、货币适配、税率处理',
    '游戏海外运营：社区管理、用户反馈、活动策划',
    '游戏出海合规：版号申请、内容审核、隐私政策',
    '海外游戏获客：Facebook广告、Google Ads、网红营销',
    '游戏数据出海：数据合规、GDPR、CCPA',
    // 游戏开发
    '游戏开发：游戏设计、美术资源、程序开发',
    '手游开发：Unity、Unreal Engine、跨平台适配',
    '游戏策划：数值设计、关卡设计、剧情设计',
    '游戏美术：角色设计、场景设计、特效制作',
    '游戏运营：版本更新、活动策划、数据分析',
    '游戏变现：内购设计、广告变现、订阅模式',
    '游戏用户分析：留存分析、付费分析、流失分析',
    '游戏测试：功能测试、性能测试、兼容性测试',
    // 电竞产业
    '电竞产业：赛事运营、选手培养、商业化',
    '电竞比赛：赛事策划、直播版权、赞助合作',
    '电竞俱乐部：选手管理、训练体系、转会交易',
    '电竞直播：直播平台、解说团队、粉丝运营',
    // 其他媒体
    '内容创作：IP孵化、剧本创作、内容策划',
    '短视频制作：拍摄技巧、剪辑软件、特效包装',
    '直播运营：直播策划、互动技巧、转化策略',
    '自媒体运营：账号定位、内容规划、粉丝运营',
    'MCN机构：达人孵化、商业变现、资源整合',
    '影视制作：制片管理、拍摄流程、后期制作',
    '音乐产业：版权运营、数字音乐、现场演出',
    '品牌营销：品牌植入、效果广告、社交传播',
    '网红经济：网红打造、商业合作、流量变现',
    'IP运营：IP授权、IP衍生、IP保护',
    '粉丝经济：粉丝运营、社群管理、粉丝变现',
    '内容审核：审核标准、审核流程、风险控制',
    '平台运营：平台规则、流量分发、推荐算法',
    '内容分发：多渠道分发、内容适配、流量优化',
    '用户增长：获客策略、留存策略、变现策略',
    '数据监测：数据采集、数据分析、数据应用',
  ],

  // 能源/环保
  energy: [
    '新能源发展：光伏、风电、储能装机预测',
    '碳中和路径：能源结构转型、节能减排措施',
    '绿色金融：碳交易、绿色债券、ESG投资',
    '智慧能源：能源互联网、虚拟电厂、需求响应',
    '新能源汽车：电池技术、充电设施、产业链',
    '环保技术：废水处理、废气治理、固废利用',
    '循环经济：资源回收、再制造、共享经济',
    '能源效率：节能技术、能耗监测、能效管理',
    '政策解读：双碳目标、新能源补贴、碳关税',
    '投资机会：储能、氢能、CCUS等前沿技术',
    '光伏发电：分布式光伏、集中式光伏、光伏组件',
    '风力发电：陆上风电、海上风电、风电运维',
    '储能技术：锂电池、液流电池、压缩空气储能',
    '氢能应用：氢能制取、氢能储运、氢能利用',
    'CCUS技术：碳捕集、碳利用、碳封存',
    '节能改造：工业节能、建筑节能、交通节能',
    '清洁取暖：煤改电、煤改气、地热取暖',
    '碳交易：碳配额、CCER、碳市场',
  ],

  // 交通/物流
  transport: [
    '智能交通：信号优化、路况预测、智慧停车',
    '自动驾驶：L2-L5级别技术路线、商业化进程',
    '新能源汽车：电池技术、充电网络、车型选择',
    '物流网络：仓网布局、路由优化、最后一公里',
    '供应链管理：JIT配送、VMI库存、可视化追踪',
    '跨境电商物流：海外仓、专线物流、清关代理',
    '快递配送：时效承诺、末端网点、智能柜',
    '货运平台：车货匹配、运价优化、信用评价',
    '出行服务：网约车、共享单车、定制公交',
    '交通规划：路网设计、公交优先、慢行系统',
    '车路协同：V2X通信、协同感知、协同决策',
    '智慧高速：自由流收费、智慧服务区、应急指挥',
    '港口物流：港口装卸、港口物流、多式联运',
    '航空物流：航空货运、冷链运输、时效保证',
    '铁路货运：中欧班列、铁路集装箱、铁海联运',
    '冷链物流：冷链运输、冷链仓储、温控技术',
    '危化品物流：危化品运输、安全监管、应急处置',
    '城乡配送：城市配送、农村物流、共同配送',
  ],

  // 农业/食品
  agriculture: [
    '智慧农业：物联网监测、精准灌溉、无人机植保',
    '特色种植：有机农业、设施农业、品种改良',
    '现代养殖：规模化养殖、疫病防控、粪污处理',
    '农产品电商：产地直供、直播带货、品牌打造',
    '食品加工：深加工、预制菜、冷链物流',
    '食品安全：溯源体系、检测认证、标准制定',
    '农业金融：保险服务、信贷支持、期货套保',
    '乡村旅游：农旅融合、民宿经济、体验农业',
    '农业科技：基因育种、生物农药、智能装备',
    '乡村振兴：产业振兴、人才振兴、文化振兴',
    '设施农业：温室大棚、植物工厂、垂直农业',
    '绿色农业：绿色食品、有机认证、地理标志',
    '数字农业：农业大数据、农业AI、区块链',
    '农产品品牌：品牌建设、品牌推广、品牌保护',
    '农业机械化：耕种收机械化、智能农机、农机服务',
    '农业社会化：托管服务、代耕代种、农业服务',
    '粮食安全：粮食生产、粮食储备、粮食流通',
  ],

  // 人力资源
  hr: [
    '招聘管理：人才画像、招聘渠道、面试技巧',
    '培训发展：新员工培训、技能提升、领导力发展',
    '绩效管理：KPI设置、OKR实施、反馈面谈',
    '薪酬激励：宽带薪酬、股权激励、福利设计',
    '组织发展：组织诊断、变革管理、文化建设',
    '员工关系：沟通机制、员工关怀、冲突处理',
    '人才盘点：九宫格、继任计划、关键人才保留',
    '灵活用工：兼职、外包、自由职业者管理',
    'HR数字化：HRIS系统、数据分析、AI面试',
    '雇主品牌：品牌定位、员工推荐、社会责任',
    '人才引进：校园招聘、社会招聘、猎头服务',
    '员工培训：入职培训、在岗培训、外派培训',
    '职业发展：职业规划、晋升通道、轮岗机制',
    '员工福利：五险一金、补充福利、弹性福利',
    '离职管理：离职面谈、离职分析、离职挽留',
    '劳动合同：合同签订、合同变更、合同解除',
    '工时管理：标准工时、综合工时、不定时工时',
    '考勤管理：打卡制度、请假制度、加班管理',
    '人事档案：档案建立、档案保管、档案转移',
  ],

  // 创业/商业
  business: [
    '创业方向：市场机会分析、赛道选择、时机判断',
    '商业计划：价值主张、商业模式、财务预测',
    '融资策略：BP撰写、路演技巧、估值谈判',
    '团队组建：合伙人选择、股权分配、激励机制',
    '产品开发：MVP验证、用户反馈、快速迭代',
    '市场推广：获客渠道、增长黑客、品牌建设',
    '财务管理：现金流管理、成本控制、盈利模式',
    '风险控制：法律风险、市场风险、财务风险',
    '出海策略：目标市场、本地化、合规经营',
    '退出机制：并购退出、IPO上市、股权转让',
    '创业融资：天使投资、VC投资、PE投资',
    '精益创业：MVP、PMF、pivot转型',
    '商业模式：平台模式、SaaS模式、订阅模式',
    '竞争分析：竞品分析、竞争优势、差异化',
    '用户增长：获客成本、留存率、LTV',
    '产品经理：需求分析、产品设计、项目管理',
    '敏捷创业：快速试错、快速迭代、快速成长',
    '创业心态：抗压能力、学习能力、执行能力',
  ],
};

// ==================== 搜索功能 ====================

/**
 * 关键词权重表
 * 用于处理跨行业的通用关键词，确保识别到正确的行业
 * 权重范围：1-5，5表示该关键词对该行业最独特、最精确
 */
const KEYWORD_WEIGHTS: Record<string, Record<string, number>> = {
  // 游戏/娱乐类高权重关键词（应优先匹配到media行业）
  game: {
    '手游': 5,
    '端游': 5,
    '游戏': 4,
    '电竞': 5,
    '手游出海': 5,
    '游戏出海': 5,
  },

  // 电商类关键词（仅在明确是电商场景时高权重）
  ecommerce: {
    '跨境电商': 5,
    '淘宝': 5,
    '天猫': 5,
    '京东': 5,
    '拼多多': 5,
    '抖音电商': 5,
    '直播带货': 4,
    '选品': 4,
    '爆款': 4,
    // "出海"在电商中权重降低，避免误匹配
    '出海': 1,
  },

  // 营销类关键词
  marketing: {
    '新媒体营销': 5,
    '内容营销': 5,
    '社交媒体': 4,
    '用户增长': 5,
    '获客': 4,
    '转化率': 4,
    // 通用营销词汇权重较低
    '营销': 2,
    '推广': 2,
    '流量': 2,
  },

  // 创业/商业类关键词
  business: {
    '商业模式': 5,
    '盈利模式': 5,
    '创业': 4,
    '融资': 4,
    '路演': 4,
    '矩阵': 3,
    '起号': 4,
    // "出海"在商业中权重也降低
    '出海': 1,
    '变现': 3,
    '赚钱': 2,
  },

  // 媒体/娱乐整体权重（游戏归属于此）
  media: {
    '手游': 5,
    '端游': 5,
    '游戏': 4,
    '电竞': 5,
    '动漫': 4,
    '漫画': 4,
    '动画': 4,
    '影视': 4,
    '剧集': 4,
    '综艺': 4,
    '音乐': 3,
    '歌曲': 3,
    '演唱会': 3,
  },
};

/**
 * 获取关键词的权重
 */
function getKeywordWeight(keyword: string, industryKey: string): number {
  const lowerKeyword = keyword.toLowerCase();

  // 检查特殊权重表
  for (const [category, weights] of Object.entries(KEYWORD_WEIGHTS)) {
    if (category === industryKey || (category === 'game' && industryKey === 'media')) {
      for (const [weightedKeyword, weight] of Object.entries(weights)) {
        if (lowerKeyword.includes(weightedKeyword.toLowerCase()) ||
            weightedKeyword.toLowerCase().includes(lowerKeyword)) {
          return weight;
        }
      }
    }
  }

  // 默认权重：根据关键词长度和精确度
  // 越长的关键词权重越高（更精确）
  if (keyword.length >= 4) return 4;
  if (keyword.length >= 3) return 3;
  return 2;
}

/**
 * 智能判断是否需要搜索
 * 基于行业关键词和专业术语识别
 */
export function shouldSearchOnline(nodeContent: string, depth: number): boolean {
  // 如果深度太深，通常不需要搜索
  if (depth > 2) return false;

  const content = nodeContent.toLowerCase();

  // 检查是否包含任何行业关键词
  for (const industry of Object.values(INDUSTRY_KEYWORDS)) {
    for (const keyword of industry.keywords) {
      if (content.includes(keyword.toLowerCase())) {
        return true;
      }
    }
  }

  // 时效性关键词 - 需要最新信息
  const timeSensitiveKeywords = [
    '最新', '2024', '2025', '2026', '趋势', '动态', '新闻',
    '价格', '费用', '成本', '行情', '汇率',
    '发布', '推出', '上线', '更新', '升级',
    '政策', '法规', '标准', '规范',
  ];

  if (timeSensitiveKeywords.some(k => content.includes(k))) {
    return true;
  }

  // 检查是否是问句形式
  if (nodeContent.includes('？') || nodeContent.includes('?') || nodeContent.includes('如何') || nodeContent.includes('怎么')) {
    return true;
  }

  // 检查是否是具体的专有名词（大写字母较多）
  const uppercaseRatio = (nodeContent.match(/[A-Z]/g) || []).length / nodeContent.length;
  if (uppercaseRatio > 0.3) {
    return true;
  }

  return false;
}

/**
 * 识别查询所属的行业（增强版 - 使用评分系统）
 * 解决"手游出海"被错误识别为电商的问题
 */
export function identifyIndustry(query: string): string | null {
  const lowerQuery = query.toLowerCase();

  // 为每个行业计算匹配分数
  const industryScores: Array<{ key: string; score: number; matches: string[] }> = [];

  for (const [key, industry] of Object.entries(INDUSTRY_KEYWORDS)) {
    let score = 0;
    const matches: string[] = [];

    for (const keyword of industry.keywords) {
      if (lowerQuery.includes(keyword.toLowerCase())) {
        // 获取该关键词的权重
        const weight = getKeywordWeight(keyword, key);
        score += weight;
        matches.push(`${keyword}(${weight})`);
      }
    }

    // 额外加分：匹配关键词数量
    score += matches.length * 0.5;

    if (score > 0) {
      industryScores.push({ key, score, matches });
    }
  }

  // 按分数排序，选择最高分的行业
  if (industryScores.length === 0) {
    return null;
  }

  industryScores.sort((a, b) => b.score - a.score);

  // 调试日志
  console.log(`[行业识别] 查询: "${query}"`);
  console.log('[行业识别] 各行业得分:', industryScores);
  console.log(`[行业识别] 最终选择: ${industryScores[0].key} (${industryScores[0].score}分)`);

  return industryScores[0].key;
}

/**
 * 生成搜索查询
 * 基于节点内容和上下文生成优化的搜索词
 */
export function generateSearchQuery(
  nodeContent: string,
  parentContent: string | null,
  _rootTopic: string
): string {
  // 如果是根节点，直接搜索主题
  if (!parentContent) {
    return `${nodeContent} 指南 方法`;
  }

  // 组合父节点和当前节点生成查询
  const query = `${parentContent} ${nodeContent}`;

  // 根据内容类型添加后缀
  const suffixes = ['方法', '指南', '技巧', '实践', '步骤', '教程', '案例分析', '最佳实践'];
  const relevantSuffix = suffixes[Math.floor(Math.random() * suffixes.length)];

  return `${query} ${relevantSuffix}`;
}

/**
 * 检测语言类型
 */
export function detectLanguage(content: string): 'zh' | 'en' | 'mixed' {
  const chineseChars = (content.match(/[\u4e00-\u9fa5]/g) || []).length;
  const totalChars = content.length;

  if (chineseChars / totalChars > 0.3) {
    return 'zh';
  } else if (chineseChars === 0) {
    return 'en';
  } else {
    return 'mixed';
  }
}

/**
 * 执行网络搜索
 * 使用全局搜索函数（如果可用）
 */
export async function searchMultiple(query: string): Promise<string[]> {
  // 检查是否有全局搜索函数（由MCP或其他方式注入）
  const globalSearch = (globalThis as any).performWebSearch;

  if (!globalSearch || typeof globalSearch !== 'function') {
    console.warn('Web search function not available, using fallback');
    return [];
  }

  try {
    const results = await globalSearch(query);
    return results || [];
  } catch (error) {
    console.error('Search failed:', error);
    return [];
  }
}

/**
 * 获取智能搜索结果（Fallback机制）
 * 基于行业知识库提供专业内容，AI可以决定使用多少条
 * @param query 搜索查询
 * @param maxCount 最大结果数量，默认10，最多100
 * @returns 搜索结果数组
 */
export function getFallbackResults(query: string, maxCount: number = 10): string[] {
  const industry = identifyIndustry(query);

  if (industry && INDUSTRY_KNOWLEDGE[industry]) {
    const allResults = INDUSTRY_KNOWLEDGE[industry];
    // 限制返回数量在1-maxCount之间，最多不超过100
    const actualCount = Math.min(Math.max(1, maxCount), 100);
    // 随机打乱并返回指定数量
    return shuffleArray([...allResults]).slice(0, actualCount);
  }

  // 如果没有识别到具体行业，返回通用商业知识
  const generalKnowledge = [
    '战略规划：明确目标、制定路径、资源配置',
    '市场分析：行业趋势、竞争格局、用户需求',
    '产品策略：产品定位、功能规划、路线图',
    '运营体系：流程设计、团队协作、绩效管理',
    '数据分析：指标体系、数据采集、洞察决策',
    '风险控制：风险识别、应对措施、预案准备',
    '持续改进：复盘总结、优化迭代、创新突破',
    '团队建设：人才招聘、能力培养、文化建设',
    '财务管理：预算管理、成本控制、盈利分析',
    '客户服务：需求响应、问题解决、关系维护',
    '项目管理：计划制定、进度跟踪、质量管理',
    '沟通协作：内部沟通、外部协调、信息共享',
    '技术选型：技术调研、方案对比、架构决策',
    '用户体验：用户研究、交互设计、体验优化',
    '品牌建设：品牌定位、品牌传播、品牌维护',
  ];
  const actualCount = Math.min(Math.max(1, maxCount), 100);
  return shuffleArray([...generalKnowledge]).slice(0, actualCount);
}

/**
 * Fisher-Yates 洗牌算法
 * 用于随机打乱数组
 */
function shuffleArray<T>(array: T[]): T[] {
  const result = [...array];
  for (let i = result.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [result[i], result[j]] = [result[j], result[i]];
  }
  return result;
}
